#!/bin/bash
RED='\033[0;31m'
NC='\033[0m' # No Color
border="###############################"
dest="/backup/clamav"
logdir="$dest/logs"
list="$dest/malware.txt"
newin="$dest/newin.txt"
datetime=`date +%Y-%m-%d`

precheck() {
 if [ ! -d "$dest" ]; then
   mkdir -p $dest
 fi
 if [ ! -d "$logdir" ]; then
   mkdir $logdir
 fi
 if [ ! -f "$list" ]; then
   touch $list
 fi 
 if ! hash clamscan 2>/dev/null; then
   if [ ! -f "/usr/local/cpanel/3rdparty/bin/clamscan" ];then
   	echo "ClamAV is not installed"
	exit
   fi
 fi
}

movefile() {
 src=$1
 ti=`date +%Y-%m-%d:%H:%M:%S`
 n_src=$(basename $src).$ti
 mv $src $dest/$n_src
}

clamav() {
 total=0
 > $newin
 logfile="clamav.log.$datetime"
 if [ -f $logdir/$logfile ]
 then
	> $logdir/$logfile
 fi
 # Directadmin
 if [ -d /usr/local/directadmin/data/users ]
 then
   users="/usr/local/directadmin/data/users"
   for usr in $(ls $users); do
     if [ -d /home/$usr ]
     then
        echo -e "Scanning user ${RED}$usr${NC}"
        clamscan -ir /home/$usr/domains |grep FOUND|cut -d':' -f1 |sed -r  "s/([^a-zA-Z0-9._/])/\1\\\/g" >> $logdir/$logfile
     fi
   done
 # Cpanel
 elif [ -d /var/cpanel/users ]
 then
   clambin="/usr/local/cpanel/3rdparty/bin/clamscan"
   users="/var/cpanel/users"
   for usr in $(ls $users); do
     if [ -d /home/$usr/public_html ]
     then
       echo -e "Scanning user ${RED}$usr${NC}"
       $clambin -ir /home/$usr/public_html |grep FOUND|cut -d':' -f1 |sed -r  "s/([^a-zA-Z0-9._/])/\1\\\/g" >> $logdir/$logfile
     fi
   done
 # Others
 else
   users="/home"
   for usr in $(ls $users); do 
     if [ -d /home/$usr/public_html ]
     then
        echo -e "Scanning user ${RED}$usr${NC}"
        clamscan -ir /home/$usr/public_html |grep FOUND|cut -d':' -f1 |sed -r  "s/([^a-zA-Z0-9._/])/\1\\\/g" >> $logdir/$logfile
     fi
   done
 fi
 echo "$border"
 echo "Scanning is finished."
 echo "Files are infected:"
 while read -r line
 do
   if ! grep -Fxq "$line" $list
   then
      total=$(($total+1))
      echo $line
      echo $line >> $list
      echo $line >> $newin
   fi
   if [ -r "$line" ] || [ -w "$line" ] || [ -x "$line" ]
   then
     chmod 000 $line
   fi
 done < $logdir/$logfile
 echo -e "Total new files are infected: ${RED}$total${NC}"
}
precheck
clamav
